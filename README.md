# Ingest Backup

## Introduction
The backup strategies devised in here is to ensure availability, and prevent significant loss of data after they have been ingested through HCA infrastructure. The utility is meant to complement a more robust way to persist data on Ingest's deployment environment.

While the strategies were created with HCA infrastructure specifically in mind, the tools may be reused to accommodate any system that uses Mongo DB deployed as part of of a cluster of Docker containers.

## Assumptions
Ingest infrastructure is deployed as a system of multiple self contained microservices through Docker with the use of Kubernetes. The backup system is deployed as a Docker container that has direct access to a predefined `mongo-service` Kubernetes service, from which it gets the data it backs up to an S3 bucket defined through the `S3_BUCKET` environment variable.

## Usage
By default, the backup system is set to run every second hour of the day between 0000H to 2300H, or, in other terms, on hours of the day divisible by 2 (`hour % 2 == 0`). This can be configured by updating the cron schedule in the `backup.yml` file to match another preferred schedule.

### Security Credentials
The backup system uses Amazon's AWS CLI tools to copy data to AWS. As the backup data will be dumped into a remote S3 bucket, the process running the backups need to be configured to have access to the bucket in question. Security credentials should be set through the environment variables to get the backup system working correctly. AWS provides documentation on [how to setup security credentials for the AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html).

### Environment Variables
Several environment variables are defined as part of the configuration of the running container.

* `AWS_ACCESS_KEY_ID` - the access key ID generated by AWS for the IAM user running the backup utility
* `AWS_SECRET_ACCESS_KEY` - the secret access key generated by AWS for the IAM user running the backup utility
* `S3_BUCKET` - the name of the AWS S3 to which the backup data will be moved
* `BACKUP_DIR` - a subdirectory in the S3 bucket to which the data will be copied. This is useful for when there are multiple environments sharing the same S3 bucket for backup (e.g. dev, integration, production)

The first 2 environment variables above (access keys) are directly exposed variables used by AWS client itself.
